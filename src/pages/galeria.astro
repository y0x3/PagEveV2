<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Galería Completa</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/styles/galeria.css" />
  </head>
  <body>
    <h1>Galería Completa</h1>

    <div class="gallery-container" id="galleryContainer">
      <p>Cargando imágenes...</p>
    </div>
    <!-- Modal para mostrar imagen ampliada -->
    <div id="modal" class="modal" onclick="closeModal()">
      <img id="modal-img" src="" alt="Imagen ampliada">
    </div>

    <footer>
      <a href="/" id="backBtn" class="back-btn">
        Regresar a la página principal
      </a>
    </footer>
    

    <script is:inline>
      document.addEventListener('DOMContentLoaded', () => {
      const galleryContainer = document.getElementById('galleryContainer');
      let nextCursor = null; // Cursor para la paginación
      let isLoading = false; // Evita múltiples solicitudes simultáneas

      if (!galleryContainer) {
        console.error("El contenedor de la galería no se encontró en el DOM.");
        return;
      }

      async function loadGallery() {
        if (isLoading) return;
        isLoading = true;

        try {
          const url = `/api/cloudinary-list${nextCursor ? `?next_cursor=${nextCursor}` : ''}`;
          const response = await fetch(url, {
            cache: 'no-store',
          });

          if (!response.ok) {
            throw new Error(`Error al obtener las imágenes: ${response.statusText}`);
          }

          const data = await response.json();

          if (!nextCursor) {
            galleryContainer.innerHTML = '';
          }

          data.images.forEach((url) => {
            const card = document.createElement('div');
            card.className = 'card';

            const img = document.createElement('img');
            img.src = url;
            img.alt = 'Imagen de la galería';
            img.className = 'gallery-image';

            img.addEventListener('click', () => openModal(url));

            card.appendChild(img);
            galleryContainer.appendChild(card);
          });

          nextCursor = data.next_cursor;

          if (!nextCursor) {
            console.log('No hay más imágenes para cargar.');
          }
        } catch (error) {
          console.error('Error al cargar la galería:', error);
        } finally {
          isLoading = false;
        }
      }

      function handleScroll() {
        const scrollableElement = document.documentElement || document.body;
        const { scrollTop, scrollHeight, clientHeight } = scrollableElement;

        console.log('Scroll detectado:', { scrollTop, scrollHeight, clientHeight });

        if (scrollTop + clientHeight >= scrollHeight - 100 && nextCursor && !isLoading) {
          console.log('Cargando más imágenes...');
          loadGallery();
        }
      }

      loadGallery();
      window.addEventListener('scroll', handleScroll);

      function openModal(imageSrc) {
        const modal = document.getElementById('modal');
        const modalImg = document.getElementById('modal-img');
        modal.style.display = 'flex';
        modalImg.src = imageSrc;
      }

      function closeModal() {
        const modal = document.getElementById('modal');
        modal.style.display = 'none';
      }
    });
    </script>
  </body>
</html>