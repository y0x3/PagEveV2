<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Galería Completa</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/styles/galeria.css" />
  </head>
  <body>
    <h1>Galería Completa</h1>

    <div class="gallery-container" id="galleryContainer">
      <p>Cargando imágenes...</p>
    </div>

    <!-- Modal para mostrar imagen ampliada -->
    <div id="modal" class="modal" onclick="closeModal()">
      <img id="modal-img" src="" alt="Imagen ampliada">
    </div>

    <footer>
      <a href="/" id="backBtn" class="back-btn">
        Regresar a la página principal
      </a>
    </footer>
    

    <script is:inline>
      document.addEventListener('DOMContentLoaded', () => {
        const galleryContainer = document.getElementById('galleryContainer');
        let nextCursor = null; // Cursor para la paginación
        let isLoading = false; // Evita múltiples solicitudes simultáneas

        if (!galleryContainer) {
          console.error("El contenedor de la galería no se encontró en el DOM.");
          return;
        }

        // Función para cargar las imágenes desde la API
        async function loadGallery() {
          if (isLoading) return; // Evita cargar si ya hay una solicitud en curso
          isLoading = true;

          try {
            const url = `/api/cloudinary-list${nextCursor ? `?next_cursor=${nextCursor}` : ''}`;
            const response = await fetch(url, {
              cache: 'no-store', // Asegúrate de que no use caché
            });

            if (!response.ok) {
              throw new Error(`Error al obtener las imágenes: ${response.statusText}`);
            }

            const data = await response.json();

            // Limpia el contenedor solo en la primera carga
            if (!nextCursor) {
              galleryContainer.innerHTML = '';
            }

            // Agrega las imágenes al contenedor
            data.images.forEach((url) => {
              const card = document.createElement('div');
              card.className = 'card'; // Aplica el estilo de la tarjeta

              const img = document.createElement('img');
              img.src = url;
              img.alt = 'Imagen de la galería';
              img.className = 'gallery-image';

              // Agregar evento para abrir la imagen en el modal
              img.addEventListener('click', () => openModal(url));

              card.appendChild(img); // Agrega la imagen dentro de la tarjeta
              galleryContainer.appendChild(card); // Agrega la tarjeta al contenedor
            });

            // Actualiza el cursor para la siguiente página
            nextCursor = data.next_cursor;

            // Si no hay más imágenes, elimina el evento de scroll
            if (!nextCursor) {
              window.removeEventListener('scroll', handleScroll);
            }
          } catch (error) {
            console.error('Error al cargar la galería:', error);
          } finally {
            isLoading = false; // Permite nuevas solicitudes
          }
        }

        // Función para manejar el evento de scroll
        function handleScroll() {
          const scrollableElement = document.documentElement || document.body; // Asegúrate de usar el contenedor correcto
          const { scrollTop, scrollHeight, clientHeight } = scrollableElement;

          if (scrollTop + clientHeight >= scrollHeight - 100) {
            loadGallery(); // Carga más imágenes cuando el usuario llega al final
          }
        }

        // Llama a la función para cargar la galería inicialmente
        loadGallery();

        // Agrega el evento de scroll y touchmove
        window.addEventListener('scroll', handleScroll);
        window.addEventListener('touchmove', handleScroll);

        // Función para abrir el modal con la imagen seleccionada
        function openModal(imageSrc) {
          const modal = document.getElementById('modal');
          const modalImg = document.getElementById('modal-img');
          modal.style.display = 'flex';
          modalImg.src = imageSrc;
        }

        // Función para cerrar el modal al hacer clic fuera de la imagen
        function closeModal() {
          const modal = document.getElementById('modal');
          modal.style.display = 'none';
        }
      });
    </script>
  </body>
</html>